{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - JIT BusTrack</title>

    <link rel="stylesheet" href="{% static 'accounts/css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="dashboard-body">

    <main class="dashboard-main">
        <header class="topbar">
            <h1 class="page-title">Dashboard</h1>
            <a href="{% url 'home' %}" class="back-home-btn">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </header>


        <div class="dashboard-content">

            <div class="simple-grid">
                <div class="left-panel">

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3><i class="fas fa-gas-pump"></i> Fuel Level</h3>
                        </div>
                        <div class="card-body">
                            <h2><span id="fuel">--</span> %</h2>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3><i class="fas fa-tachometer-alt"></i> Speed</h3>
                        </div>
                        <div class="card-body">
                            <h2><span id="speed">--</span> km/h</h2>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3><i class="fas fa-thermometer-half"></i> Temperature</h3>
                        </div>
                        <div class="card-body">
                            <h2><span id="temp">--</span> Â°C</h2>
                        </div>
                    </div>

                </div>


                <div class="right-panel">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3><i class="fas fa-map-marker-alt"></i> Live GPS Location</h3>
                        </div>
                        <div class="card-body">
                            <div id="map" class="map-container"></div>

                            <div class="map-info">
                                <div class="map-info-item">
                                    <strong>Latitude:</strong> <span id="lat">--</span>
                                </div>
                                <div class="map-info-item">
                                    <strong>Longitude:</strong> <span id="lng">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </main>

    {% comment %} INLINE LEAFLET JS (ONLY THIS JS) {% endcomment %}
    {% comment %}
    <script>

        var lat = 22.7196;
        var lng = 75.8577;


        var map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);


        var marker = L.marker([lat, lng]).addTo(map);

        document.getElementById("lat").innerText = lat;
        document.getElementById("lng").innerText = lng;
        document.getElementById("fuel").innerText = 72;
        document.getElementById("speed").innerText = 48;
        document.getElementById("temp").innerText = 34;
    </script> {% endcomment %}



    <script>

        var lat = 22.7196;
        var lng = 75.8577;
        var map = L.map('map').setView([lat, lng], 13);


        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);


        //L.marker([lat, lng]).addTo(map);
        var marker = L.marker([lat, lng]).addTo(map);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>
{% if messages %}
{% for message in messages %}
{% if 'success' in message.tags %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Registration Successful ðŸŽ‰',
        text: '{{ message }}',
        timer: 3000,
        showConfirmButton: false
    });
</script>
{% endif %}

{% if 'error' in message.tags %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: '{{ message }}'
    });
</script>
{% endif %}
{% endfor %}
{% endif %}
<script>
    async function fetchBusData() {
        try {
            const response = await fetch("/api/get/");
            const data = await response.json();

            if (data.latitude) {

                document.getElementById("fuel").innerText =
                    data.fuel_level ? data.fuel_level.toFixed(1) : "--";

                document.getElementById("speed").innerText =
                    data.speed ?? "--";

                document.getElementById("temp").innerText =
                    data.temperature ?? "--";

                document.getElementById("lat").innerText =
                    data.latitude.toFixed(5);

                document.getElementById("lng").innerText =
                    data.longitude.toFixed(5);


                map.setView([data.latitude, data.longitude], 15);
                marker.setLatLng([data.latitude, data.longitude]);
            }

        } catch (error) {
            console.error("Error fetching bus data:", error);
        }
    }


    setInterval(fetchBusData, 5000);
    fetchBusData();
</script>